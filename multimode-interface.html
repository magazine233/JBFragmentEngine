<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>myGov - Multi-Mode Interface</title>

        <!-- Material-UI -->
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
        />

        <!-- React & Dependencies -->
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/@mui/material@5.14.0/umd/material-ui.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/@babel/standalone/babel.min.js"
        ></script>

        <style>
            body {
                margin: 0;
                font-family: "Roboto", sans-serif;
                background-color: #f5f5f5;
            }
            .chat-messages {
                height: 400px;
                overflow-y: auto;
                padding: 16px;
                background-color: #fafafa;
                border-radius: 4px;
                margin-bottom: 16px;
            }
            .chat-message {
                margin-bottom: 16px;
                display: flex;
                align-items: flex-start;
                gap: 8px;
            }
            .chat-message.user {
                flex-direction: row-reverse;
            }
            .chat-bubble {
                max-width: 70%;
                padding: 12px 16px;
                border-radius: 16px;
                background-color: #e0e0e0;
            }
            .chat-message.user .chat-bubble {
                background-color: #1976d2;
                color: white;
            }
            .chat-avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: 500;
            }
            .chat-message.assistant .chat-avatar {
                background-color: #66d3ee;
                color: #333;
            }
            .chat-message.user .chat-avatar {
                background-color: #1976d2;
                color: white;
            }
            .chat-message.system {
                justify-content: center;
            }
            .chat-message.system .chat-avatar {
                background-color: #ff9800;
                color: white;
                font-size: 12px;
            }
            .chat-message.system .chat-bubble {
                background-color: #fff3e0;
                border: 1px solid #ffcc02;
                color: #ef6c00;
                font-style: italic;
                font-size: 14px;
            }
            /* Markdown styling within chat messages */
            .chat-bubble strong {
                font-weight: 600;
            }
            .chat-bubble em {
                font-style: italic;
            }
            .chat-bubble a {
                color: inherit;
                text-decoration: underline;
                text-underline-offset: 2px;
            }
            .chat-bubble.user a {
                color: #e3f2fd;
            }
            .chat-bubble code {
                background-color: rgba(0, 0, 0, 0.1);
                padding: 2px 4px;
                border-radius: 3px;
                font-family: 'Courier New', monospace;
                font-size: 0.9em;
            }
            .chat-bubble.user code {
                background-color: rgba(255, 255, 255, 0.2);
            }
            .content-section {
                margin-bottom: 32px;
            }
            .content-card {
                transition: transform 0.2s;
            }
            .content-card:hover {
                transform: translateY(-2px);
            }
            .filter-chips {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-bottom: 16px;
            }
            .logo-container {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .logo-image {
                height: 40px;
                width: auto;
            }
            @media print {
                .MuiAppBar-root,
                .MuiBottomNavigation-root {
                    display: none !important;
                }
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const {
                AppBar,
                Toolbar,
                Typography,
                Container,
                Box,
                Card,
                CardContent,
                Button,
                IconButton,
                TextField,
                Chip,
                Paper,
                Grid,
                List,
                ListItem,
                ListItemText,
                ListItemIcon,
                Checkbox,
                Accordion,
                AccordionSummary,
                AccordionDetails,
                Badge,
                LinearProgress,
                ToggleButton,
                ToggleButtonGroup,
                Tabs,
                Tab,
                Dialog,
                DialogTitle,
                DialogContent,
                DialogActions,
                Menu,
                MenuItem,
                Snackbar,
                Alert,
                Divider,
                InputAdornment,
                Select,
                InputLabel,
                Radio,
                RadioGroup,
                FormControlLabel,
                FormControl,
                FormLabel,
                Avatar,
                Stack,
                Fade,
                Grow,
                Collapse,
                CircularProgress,
                Link,
            } = MaterialUI;

            const { useState, useEffect, useRef, useCallback } = React;

            // API Configuration
            const API_BASE_URL = "http://localhost:3000";
            const API_ENDPOINTS = {
                search: `${API_BASE_URL}/api/fragments/search`,
                facets: `${API_BASE_URL}/api/fragments/facets`,
                ollama: `${API_BASE_URL}/api/ollama/chat`,
                llm: `${API_BASE_URL}/api/llm/chat`,
                llmWithContext: `${API_BASE_URL}/api/llm/chat-with-context`,
                llmModels: `${API_BASE_URL}/api/llm/models`,
            };

            // Category to Life Event mappings - FIXED TO MATCH ACTUAL API DATA
            const categoryToLifeEvents = {
                "Health and caring": [
                    "Seeking medical help",
                    "Being diagnosed with a medical condition or disability",
                    "Experiencing mental illness",
                    "Being seriously injured",
                    "Providing temporary care for another",
                    "Becoming a long term carer",
                    "Ceasing to be a carer",
                    "Experiencing the death of a loved one",
                    "Coming to the end of your life",
                    "Becoming an older Australian",
                    "Accessing aged care",
                ],
                "Family and relationships": [
                    "Getting together",
                    "Making it work",
                    "Breaking up",
                    "Having a baby",
                    "Adopting a child",
                    "Fostering a child",
                    "Raising a child to adulthood",
                    "Separated parents",
                    "Estrangement from family",
                    "Getting a pet",
                ],
                "Work and Money": [
                    // Fixed capitalization
                    "Working",
                    "Changing careers",
                    "Returning to work",
                    "Experiencing workplace conflict",
                    "Becoming unemployed",
                    "Looking for work",
                    "Retiring from the workforce",
                    "Starting a business",
                    "Establishing trade",
                    "Growing a business",
                    "Having a business fail",
                    "Closing a business",
                    "Selling a business",
                    "Experiencing financial stress",
                ],
                "Housing and Travel": [
                    // Fixed capitalization
                    "Coming to Australia to visit",
                    "Moving to Australia permanently",
                    "Coming to Australia as a refugee",
                    "Renting a home",
                    "Buying a home",
                    "Moving into an existing household",
                    "Experiencing homelessness",
                    "Moving domestically",
                    "Moving abroad",
                    "Travelling within Australia",
                    "Travelling overseas",
                ],
                "Disasters and Crime": [
                    // Fixed capitalization
                    "Being the victim of a crime",
                    "Being arrested and charged with a crime",
                    "Being involved in a lawsuit",
                    "Being sentenced and serving your sentence",
                    "Being released from prison",
                    "Experiencing domestic violence",
                    "Leaving a violent relationship",
                    "Being removed from your family",
                    "Experiencing a war",
                    "Experiencing terrorist act",
                    "Experiencing a major industrial accident",
                    "Experiencing a pandemic",
                    "Experiencing a sudden disaster",
                    "Experiencing a gradual disaster",
                ],
                "Education and Identity": [
                    // Fixed capitalization
                    "Becoming a driver",
                    "Becoming financially independent",
                    "Moving out of home for the first time",
                    "Coming out",
                    "Changing gender identity",
                    "Changing national identity",
                    "Change in religious beliefs",
                    "Transitioning to civilian life",
                    "Studying at primary school",
                    "Studying at high school",
                    "Studying at a tertiary institution",
                    "Becoming an apprentice",
                    "Upgrading professional skills or qualifications",
                    "Coming to Australia temporarily",
                ],
            };

            function App() {
                const [mode, setMode] = useState("browse"); // browse, home, search, chat
                const [facetsData, setFacetsData] = useState(null);
                const [results, setResults] = useState([]);
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState(null);

                // Selection state
                const [selections, setSelections] = useState({
                    category: null,
                    lifeEvent: null,
                    provider: null,
                });

                // Search state
                const [searchQuery, setSearchQuery] = useState("");
                const [searchFilters, setSearchFilters] = useState({
                    category: null,
                    lifeEvent: null,
                    provider: null,
                    state: null,
                });

                // Chat state
                const [chatMessages, setChatMessages] = useState([
                    {
                        type: "assistant",
                        text: "Hello! I'm here to help you find government services. What can I help you with today?",
                    },
                ]);
                const [chatInput, setChatInput] = useState("");
                const [ollamaModel, setOllamaModel] = useState("gemma3:27b"); // Default model (kept for backward compat)
                const [llmModel, setLlmModel] = useState("ollama:gemma3:27b");
                const [availableModels, setAvailableModels] = useState([]);

                // Load available LLM models from API
                const [modelStatus, setModelStatus] = useState(null);
                const [modelRecommendations, setModelRecommendations] = useState(null);
                const [loadingModels, setLoadingModels] = useState(false);
                
                // AI Summary state
                const [aiSummary, setAiSummary] = useState(null);
                const [loadingSummary, setLoadingSummary] = useState(false);
                
                // AI Reordering state
                const [reorderedResults, setReorderedResults] = useState(null);
                const [loadingReorder, setLoadingReorder] = useState(false);
                
                // Function to parse markdown to HTML
                const parseMarkdown = (text) => {
                    if (!text) return '';
                    
                    return text
                        // Bold text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        // Italic text
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        // Links
                        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                        // Line breaks
                        .replace(/\n/g, '<br>')
                        // Code inline
                        .replace(/`([^`]+)`/g, '<code>$1</code>');
                };

                const loadModels = async () => {
                    setLoadingModels(true);
                    try {
                        const resp = await fetch(API_ENDPOINTS.llmModels);
                        if (resp.ok) {
                            const data = await resp.json();
                            const list = data.models || [];
                            setAvailableModels(list);
                            setModelStatus(data.status);
                            setModelRecommendations(data.recommendations);
                            
                            // Select first available model if current is unavailable
                            const currentModel = list.find(m => m.value === llmModel);
                            if (!currentModel || currentModel.status !== 'available') {
                                const availableModel = list.find(m => m.status === 'available');
                                if (availableModel) {
                                    setLlmModel(availableModel.value);
                                } else if (list.length > 0) {
                                    setLlmModel(list[0].value);
                                }
                            }
                        } else {
                            throw new Error("Failed to load models");
                        }
                    } catch (e) {
                        console.warn("Falling back to default model list:", e.message);
                        const fallback = [
                            { 
                                value: "ollama:gemma3:27b", 
                                label: "Ollama â€¢ gemma3:27b (connection error)", 
                                provider: "ollama",
                                status: "unavailable"
                            }
                        ];
                        setAvailableModels(fallback);
                        setError("Could not load available models. Check your connection to the API server.");
                    } finally {
                        setLoadingModels(false);
                    }
                };
                
                useEffect(() => {
                    loadModels();
                }, []);

                // Generate AI summary for search results
                const generateSummary = async (searchResults) => {
                    if (!searchResults || searchResults.length === 0 || !llmModel) return;
                    
                    setLoadingSummary(true);
                    try {
                        // Prepare content for summarization
                        const resultsText = searchResults.map(result => 
                            `Title: ${result.document.title}\n` +
                            `Provider: ${result.document.provider || 'N/A'}\n` +
                            `Content: ${result.document.content_text || 'No content'}\n` +
                            `URL: ${result.document.url}`
                        ).join('\n\n---\n\n');

                        const summaryPrompt = `Please provide a concise summary of these search results. Focus on:
1. What types of information/services are covered
2. Key themes or topics
3. Which government providers are involved
4. Any patterns or connections between results

IMPORTANT: Only summarize what is provided - do not add any new information or recommendations.

Search Results:
${resultsText}`;

                        const response = await fetch(API_ENDPOINTS.llm, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                model: llmModel,
                                prompt: summaryPrompt,
                            }),
                        });

                        const data = await response.json();
                        if (response.ok) {
                            setAiSummary(data.response);
                        } else {
                            console.error('Summary generation failed:', data.error);
                        }
                    } catch (error) {
                        console.error('Summary generation error:', error);
                    } finally {
                        setLoadingSummary(false);
                    }
                };

                // Reorder content for better reading flow (Home page)
                const reorderContentForFlow = async (contentResults) => {
                    if (!contentResults || contentResults.length === 0 || !llmModel) return;
                    
                    setLoadingReorder(true);
                    try {
                        // Prepare content list with IDs and titles
                        const contentList = contentResults.map((result, index) => ({
                            id: result.id,
                            index: index,
                            title: result.title,
                            description: result.description || '',
                            category: result.category,
                            provider: result.provider
                        }));

                        const reorderPrompt = `You are helping organize government information for better reading flow. 
Given the following content fragments, reorder them to create a more logical and cohesive reading experience.

IMPORTANT RULES:
1. You MUST return ONLY a JSON array of indices in the new order
2. You MUST use every index exactly once (no additions, no removals)
3. Consider logical flow: general info â†’ specific services â†’ forms/applications â†’ additional resources
4. Group related topics together
5. DO NOT generate any new content or explanations

Content fragments:
${JSON.stringify(contentList, null, 2)}

Return ONLY a JSON array of the indices in the optimal reading order, like: [2, 0, 1, 3, ...]`;

                        const response = await fetch(API_ENDPOINTS.llm, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                model: llmModel,
                                prompt: reorderPrompt,
                            }),
                        });

                        const data = await response.json();
                        if (response.ok) {
                            try {
                                // Extract JSON array from response (handle if model adds extra text)
                                const responseText = data.response;
                                const jsonMatch = responseText.match(/\[[\d,\s]+\]/);
                                if (jsonMatch) {
                                    const newOrder = JSON.parse(jsonMatch[0]);
                                    
                                    // Validate the order array
                                    if (Array.isArray(newOrder) && 
                                        newOrder.length === contentResults.length &&
                                        new Set(newOrder).size === newOrder.length) {
                                        
                                        // Reorder the results based on AI suggestion
                                        const reordered = newOrder.map(index => contentResults[index]);
                                        setReorderedResults(reordered);
                                        return reordered;
                                    }
                                }
                            } catch (parseError) {
                                console.error('Failed to parse reorder response:', parseError);
                            }
                        }
                    } catch (error) {
                        console.error('Content reordering error:', error);
                    } finally {
                        setLoadingReorder(false);
                    }
                    
                    return null; // Return null if reordering fails
                };

                // Progress tracking
                const [completedTasks, setCompletedTasks] = useState([]);

                // Export menu
                const [exportAnchor, setExportAnchor] = useState(null);

                // Load facets on mount
                useEffect(() => {
                    loadFacets();
                }, []);

                // Load results when selections change
                useEffect(() => {
                    if (mode === "browse" || mode === "home") {
                        if (
                            selections.category &&
                            selections.lifeEvent &&
                            selections.provider
                        ) {
                            loadResults();
                        }
                    }
                }, [selections, mode]);

                const loadFacets = async () => {
                    try {
                        const response = await fetch(API_ENDPOINTS.facets);
                        if (!response.ok)
                            throw new Error("Failed to load facets");
                        const data = await response.json();
                        setFacetsData(data);
                    } catch (err) {
                        setError(
                            "Failed to load options. Please check if the API is running.",
                        );
                        console.error(err);
                    }
                };

                const loadResults = async (searchParams = {}) => {
                    setLoading(true);
                    setError(null);

                    try {
                        const params = new URLSearchParams({
                            q: searchParams.q || "*",
                            include_html: "true",
                            per_page: "100",
                        });

                        // Add filters based on mode
                        if (mode === "browse" || mode === "home") {
                            if (selections.category)
                                params.append("category", selections.category);
                            if (selections.lifeEvent)
                                params.append(
                                    "life_event",
                                    selections.lifeEvent,
                                );
                            if (
                                selections.provider &&
                                selections.provider !== "All providers"
                            ) {
                                params.append("provider", selections.provider);
                            }
                        } else if (mode === "search") {
                            if (searchFilters.category)
                                params.append(
                                    "category",
                                    searchFilters.category,
                                );
                            if (searchFilters.lifeEvent)
                                params.append(
                                    "life_event",
                                    searchFilters.lifeEvent,
                                );
                            if (searchFilters.provider)
                                params.append(
                                    "provider",
                                    searchFilters.provider,
                                );
                            if (searchFilters.state)
                                params.append("state", searchFilters.state);
                        }

                        const response = await fetch(
                            `${API_ENDPOINTS.search}?${params}`,
                        );
                        if (!response.ok) throw new Error("Failed to search");
                        const data = await response.json();

                        const processedResults = data.results.map((hit) => ({
                            id: hit.document.id,
                            url: hit.document.url,
                            title: hit.document.title,
                            description: hit.document.content_text,
                            content_html: hit.document.content_html,
                            category:
                                hit.document.categories?.[0] || "General",
                            lifeEvent:
                                hit.document.life_events?.[0] || "General",
                            provider:
                                hit.document.provider ||
                                "Services Australia",
                            state: hit.document.states?.[0] || "National",
                            hierarchy:
                                hit.document.hierarchy_lvl0 ||
                                hit.document.title,
                            document: hit.document // Keep original document for summary
                        }));
                        
                        setResults(processedResults);
                        
                        // Generate AI summary for search mode
                        if (mode === "search" && data.results.length > 0) {
                            setAiSummary(null); // Clear previous summary
                            generateSummary(data.results);
                        }
                        
                        // Reorder content for home mode
                        if (mode === "home" && processedResults.length > 0) {
                            setReorderedResults(null); // Clear previous reordering
                            reorderContentForFlow(processedResults);
                        }
                    } catch (err) {
                        setError("Failed to load results. Please try again.");
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                };

                const handleSearch = () => {
                    loadResults({ q: searchQuery });
                };

                const handleChatSend = async () => {
                    if (!chatInput.trim()) return;

                    const userMessage = chatInput;
                    setChatInput("");

                    // Add user message
                    setChatMessages((prev) => [
                        ...prev,
                        { type: "user", text: userMessage },
                    ]);

                    // Add a loading message
                    const loadingId = Date.now();
                    setChatMessages((prev) => [
                        ...prev,
                        {
                            type: "assistant",
                            text: "Thinking...",
                            id: loadingId,
                            loading: true,
                        },
                    ]);

                    try {
                        // First, search for relevant content using Typesense
                        const searchResponse = await fetch(
                            `${API_ENDPOINTS.search}?${new URLSearchParams({
                                q: userMessage,
                                per_page: "5",
                                include_html: "false",
                            })}`,
                        );

                        let context = "";
                        if (searchResponse.ok) {
                            const searchData = await searchResponse.json();
                            context = searchData.results
                                .map(
                                    (hit) =>
                                        `Title: ${hit.document.title}\nContent: ${hit.document.content_text}\nProvider: ${hit.document.provider}`,
                                )
                                .join("\n\n---\n\n");
                        }

                        // Prepare the prompt with context
                        const systemPrompt = `You are a helpful Australian government services assistant. Use the following search results to answer the user's question. If the search results don't contain relevant information, provide general guidance and suggest where they might find more information.

Search Results:
${context || "No specific results found for this query."}

Remember to:
- Be helpful and concise
- Reference specific services or providers when mentioned in the search results
- Suggest visiting official government websites for the most up-to-date information
- If discussing eligibility or requirements, note that these can vary and users should check official sources`;

                        const fullPrompt = `${systemPrompt}\n\nUser: ${userMessage}\n\nAssistant:`;

                        console.log("Using MCP-powered context-aware chat with model:", llmModel);

                        // Add progress indicator message
                        const searchingId = `searching-${Date.now()}`;
                        setChatMessages((prev) => [
                            ...prev,
                            {
                                type: "system",
                                text: "ðŸ” Searching government information database...",
                                id: searchingId,
                                timestamp: new Date().toLocaleTimeString(),
                            },
                        ]);

                        // Small delay to ensure searching message is visible
                        await new Promise(resolve => setTimeout(resolve, 500));

                        // Call MCP-powered context-aware endpoint  
                        const response = await fetch(API_ENDPOINTS.llmWithContext, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                model: llmModel,
                                prompt: userMessage, // Use original user message, not fullPrompt
                                search_options: {
                                    per_page: 5
                                }
                            }),
                        });

                        // Update searching message to show completion
                        setChatMessages((prev) => 
                            prev.map(msg => 
                                msg.id === searchingId 
                                    ? { ...msg, text: "âœ… Search completed, generating response..." }
                                    : msg
                            )
                        );

                        // Small delay to show completion message
                        await new Promise(resolve => setTimeout(resolve, 300));

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(
                                data.error ||
                                    `Server returned ${response.status}`,
                            );
                        }

                        // Show sources found (if any)
                        if (data.context && data.context.results_found > 0) {
                            const sourcesId = `sources-${Date.now()}`;
                            setChatMessages((prev) => [
                                ...prev.filter(msg => msg.id !== loadingId && msg.id !== searchingId), // Remove loading and searching messages
                                {
                                    type: "system",
                                    text: `âœ… Found ${data.context.results_found} relevant result(s)`,
                                    id: sourcesId,
                                    timestamp: new Date().toLocaleTimeString(),
                                    sources: data.context.sources
                                },
                                {
                                    type: "assistant",
                                    text: data.response,
                                    id: loadingId,
                                    context: data.context
                                }
                            ]);
                        } else {
                            // Replace loading message with actual response (no context found)
                            setChatMessages((prev) =>
                                prev.filter(msg => msg.id !== searchingId) // Remove searching message
                                    .map((msg) =>
                                        msg.id === loadingId
                                            ? {
                                                  type: "assistant",
                                                  text: data.response,
                                                  id: loadingId,
                                                  context: data.context || null
                                              }
                                            : msg,
                                    ),
                            );
                        }
                    } catch (error) {
                        console.error("Chat error:", error);

                        let errorMessage = "Sorry, I encountered an error. ";
                        let suggestion = null;

                        if (error.message.includes("Failed to fetch")) {
                            errorMessage +=
                                "Could not connect to the API server. Please ensure the API is running on port 3000.";
                        } else {
                            // Try to parse structured error from API
                            try {
                                const errorData = JSON.parse(error.message);
                                errorMessage += errorData.error || error.message;
                                suggestion = errorData.suggestion;
                            } catch {
                                // Handle direct API errors with structured response
                                if (response && !response.ok) {
                                    const errorData = await response.json();
                                    errorMessage += errorData.error || error.message;
                                    suggestion = errorData.suggestion;
                                } else {
                                    // Fallback to basic error handling
                                    if (error.message.includes("Cannot connect to Ollama")) {
                                        errorMessage += "The API server cannot reach Ollama. Please ensure Ollama is running (ollama serve).";
                                    } else if (error.message.includes("404") || error.message.toLowerCase().includes("model")) {
                                        errorMessage += `Model not available. If using Ollama, try: ollama pull ${llmModel.replace('ollama:', '')}`;
                                    } else {
                                        errorMessage += error.message;
                                    }
                                }
                            }
                        }

                        // Replace loading message with error message and remove searching message
                        setChatMessages((prev) =>
                            prev.filter(msg => msg.id !== searchingId) // Remove searching message
                                .map((msg) =>
                                    msg.id === loadingId
                                        ? {
                                              type: "assistant",
                                              text: errorMessage + (suggestion ? `\n\nðŸ’¡ Suggestion: ${suggestion}` : ''),
                                              id: loadingId,
                                              error: true,
                                          }
                                        : msg,
                                ),
                        );
                    }
                };

                const toggleTask = (taskId) => {
                    setCompletedTasks((prev) => {
                        if (prev.includes(taskId)) {
                            return prev.filter((id) => id !== taskId);
                        } else {
                            return [...prev, taskId];
                        }
                    });
                };

                const progress =
                    results.length > 0
                        ? (completedTasks.length / results.length) * 100
                        : 0;

                // ADD FILTERING HELPER FUNCTIONS
                const getFilteredLifeEvents = () => {
                    const selectedCategory =
                        mode === "search"
                            ? searchFilters.category
                            : selections.category;
                    if (!selectedCategory || !facetsData?.life_events)
                        return [];

                    // Get allowed life events for selected category
                    const allowedEvents =
                        categoryToLifeEvents[selectedCategory] || [];

                    // Filter facets data to only include allowed events
                    return facetsData.life_events
                        .filter((event) => allowedEvents.includes(event.value))
                        .sort((a, b) => b.count - a.count);
                };

                // Also add debug logging to see what's happening
                const debugCategoryMapping = (category) => {
                    console.log("Selected category:", category);
                    console.log(
                        "Available mappings:",
                        Object.keys(categoryToLifeEvents),
                    );
                    console.log(
                        "Mapped events:",
                        categoryToLifeEvents[category],
                    );
                    console.log(
                        "Facets life events:",
                        facetsData?.life_events?.map((e) => e.value),
                    );
                };

                const iconMap = {
                    "Health and caring": "favorite",
                    "Family and relationships": "people",
                    "Work and money": "attach_money",
                    "Housing and travel": "home",
                    "Disasters and crime": "warning",
                    "Education and identity": "school",
                    "Having a baby": "child_friendly",
                    "Growing up": "child_care",
                    "Child health": "health_and_safety",
                    "Relationship changes": "favorite_border",
                    "Domestic violence": "report_problem",
                    Work: "work",
                    Ageing: "elderly",
                    Education: "school",
                    "All providers": "public",
                    "Services Australia": "account_balance",
                    "Australian Taxation Office": "receipt",
                    "Department of Health": "local_hospital",
                    "Department of Education": "backpack",
                    "State Government": "location_on",
                    "Non-Government": "business",
                };

                const getIcon = (name) => iconMap[name] || "circle";

                return (
                    <>
                        <AppBar
                            position="sticky"
                            sx={{ bgcolor: "#66d3ee", color: "#333" }}
                        >
                            <Toolbar>
                                <Box
                                    className="logo-container"
                                    sx={{ flexGrow: 1 }}
                                >
                                    <img
                                        src="img/logo.png"
                                        alt="myGov"
                                        className="logo-image"
                                    />
                                    <Typography variant="h6" component="div">
                                        myGov
                                    </Typography>
                                </Box>

                                <Tabs
                                    value={mode}
                                    onChange={(e, newMode) => setMode(newMode)}
                                    sx={{
                                        "& .MuiTab-root": { color: "#333" },
                                        "& .Mui-selected": { color: "#1976d2" },
                                    }}
                                >
                                    <Tab label="Home" value="home" />
                                    <Tab label="Browse" value="browse" />
                                    <Tab
                                        label="Search"
                                        value="search"
                                        icon={
                                            <span className="material-icons">
                                                search
                                            </span>
                                        }
                                        iconPosition="end"
                                    />
                                    <Tab
                                        label="Chat"
                                        value="chat"
                                        icon={
                                            <span className="material-icons">
                                                chat
                                            </span>
                                        }
                                        iconPosition="end"
                                    />
                                </Tabs>

                                <Button
                                    color="inherit"
                                    startIcon={
                                        <span className="material-icons">
                                            login
                                        </span>
                                    }
                                >
                                    Sign in
                                </Button>
                            </Toolbar>
                        </AppBar>

                        <Container maxWidth="lg" sx={{ mt: 4, mb: 4 }}>
                            {error && (
                                <Alert
                                    severity="error"
                                    sx={{ mb: 2 }}
                                    onClose={() => setError(null)}
                                >
                                    {error}
                                </Alert>
                            )}

                            {/* Navigation Questions (shown in browse, home, and search modes) */}
                            {(mode === "browse" ||
                                mode === "home" ||
                                mode === "search") && (
                                <Paper sx={{ p: 3, mb: 3 }}>
                                    <Grid container spacing={3}>
                                        <Grid
                                            item
                                            xs={12}
                                            md={mode === "search" ? 4 : 12}
                                        >
                                            <FormControl component="fieldset">
                                                <FormLabel component="legend">
                                                    What area do you need help
                                                    with?
                                                </FormLabel>
                                                <RadioGroup
                                                    row={mode !== "search"}
                                                    value={
                                                        mode === "search"
                                                            ? searchFilters.category
                                                            : selections.category
                                                    }
                                                    onChange={(e) => {
                                                        if (mode === "search") {
                                                            setSearchFilters({
                                                                ...searchFilters,
                                                                category:
                                                                    e.target
                                                                        .value,
                                                                lifeEvent: null,
                                                                provider: null,
                                                            });
                                                        } else {
                                                            // RESET LIFE EVENT WHEN CATEGORY CHANGES
                                                            setSelections({
                                                                ...selections,
                                                                category:
                                                                    e.target
                                                                        .value,
                                                                lifeEvent: null,
                                                                provider: null,
                                                            });
                                                        }
                                                        // DEBUG: Log category selection
                                                        debugCategoryMapping(
                                                            e.target.value,
                                                        );
                                                    }}
                                                >
                                                    {facetsData?.categories?.map(
                                                        (cat) => (
                                                            <FormControlLabel
                                                                key={cat.value}
                                                                value={
                                                                    cat.value
                                                                }
                                                                control={
                                                                    <Radio />
                                                                }
                                                                label={
                                                                    <Box
                                                                        sx={{
                                                                            display:
                                                                                "flex",
                                                                            alignItems:
                                                                                "center",
                                                                            gap: 1,
                                                                        }}
                                                                    >
                                                                        <span className="material-icons">
                                                                            {getIcon(
                                                                                cat.value,
                                                                            )}
                                                                        </span>
                                                                        {
                                                                            cat.value
                                                                        }
                                                                    </Box>
                                                                }
                                                            />
                                                        ),
                                                    )}
                                                </RadioGroup>
                                            </FormControl>
                                        </Grid>

                                        {/* MODIFY LIFE EVENT SECTION TO USE FILTERED OPTIONS FOR ALL MODES */}
                                        {(mode === "search"
                                            ? searchFilters.category
                                            : selections.category) && (
                                            <Grid
                                                item
                                                xs={12}
                                                md={mode === "search" ? 4 : 12}
                                            >
                                                <FormControl component="fieldset">
                                                    <FormLabel component="legend">
                                                        What life event or
                                                        situation applies?
                                                    </FormLabel>
                                                    <RadioGroup
                                                        row={mode !== "search"}
                                                        value={
                                                            mode === "search"
                                                                ? searchFilters.lifeEvent
                                                                : selections.lifeEvent
                                                        }
                                                        onChange={(e) => {
                                                            if (
                                                                mode ===
                                                                "search"
                                                            ) {
                                                                setSearchFilters(
                                                                    {
                                                                        ...searchFilters,
                                                                        lifeEvent:
                                                                            e
                                                                                .target
                                                                                .value,
                                                                    },
                                                                );
                                                            } else {
                                                                // RESET PROVIDER WHEN LIFE EVENT CHANGES
                                                                setSelections({
                                                                    ...selections,
                                                                    lifeEvent:
                                                                        e.target
                                                                            .value,
                                                                    provider:
                                                                        null,
                                                                });
                                                            }
                                                        }}
                                                    >
                                                        {/* USE FILTERED LIFE EVENTS FOR ALL MODES */}
                                                        {getFilteredLifeEvents()?.map(
                                                            (event) => (
                                                                <FormControlLabel
                                                                    key={
                                                                        event.value
                                                                    }
                                                                    value={
                                                                        event.value
                                                                    }
                                                                    control={
                                                                        <Radio />
                                                                    }
                                                                    label={
                                                                        <Box
                                                                            sx={{
                                                                                display:
                                                                                    "flex",
                                                                                alignItems:
                                                                                    "center",
                                                                                gap: 1,
                                                                            }}
                                                                        >
                                                                            <span className="material-icons">
                                                                                {getIcon(
                                                                                    event.value,
                                                                                )}
                                                                            </span>
                                                                            {
                                                                                event.value
                                                                            }
                                                                        </Box>
                                                                    }
                                                                />
                                                            ),
                                                        )}
                                                    </RadioGroup>
                                                </FormControl>
                                            </Grid>
                                        )}

                                        {(mode === "search"
                                            ? searchFilters.lifeEvent
                                            : selections.lifeEvent) && (
                                            <Grid
                                                item
                                                xs={12}
                                                md={mode === "search" ? 4 : 12}
                                            >
                                                <FormControl component="fieldset">
                                                    <FormLabel component="legend">
                                                        Which service provider?
                                                    </FormLabel>
                                                    <RadioGroup
                                                        row={mode !== "search"}
                                                        value={
                                                            mode === "search"
                                                                ? searchFilters.provider
                                                                : selections.provider
                                                        }
                                                        onChange={(e) => {
                                                            if (
                                                                mode ===
                                                                "search"
                                                            ) {
                                                                setSearchFilters(
                                                                    {
                                                                        ...searchFilters,
                                                                        provider:
                                                                            e
                                                                                .target
                                                                                .value,
                                                                    },
                                                                );
                                                            } else {
                                                                setSelections({
                                                                    ...selections,
                                                                    provider:
                                                                        e.target
                                                                            .value,
                                                                });
                                                            }
                                                        }}
                                                    >
                                                        <FormControlLabel
                                                            value="All providers"
                                                            control={<Radio />}
                                                            label={
                                                                <Box
                                                                    sx={{
                                                                        display:
                                                                            "flex",
                                                                        alignItems:
                                                                            "center",
                                                                        gap: 1,
                                                                    }}
                                                                >
                                                                    <span className="material-icons">
                                                                        {getIcon(
                                                                            "All providers",
                                                                        )}
                                                                    </span>
                                                                    All
                                                                    providers
                                                                </Box>
                                                            }
                                                        />
                                                        {facetsData?.provider?.map(
                                                            (provider) => (
                                                                <FormControlLabel
                                                                    key={
                                                                        provider.value
                                                                    }
                                                                    value={
                                                                        provider.value
                                                                    }
                                                                    control={
                                                                        <Radio />
                                                                    }
                                                                    label={
                                                                        <Box
                                                                            sx={{
                                                                                display:
                                                                                    "flex",
                                                                                alignItems:
                                                                                    "center",
                                                                                gap: 1,
                                                                            }}
                                                                        >
                                                                            <span className="material-icons">
                                                                                {getIcon(
                                                                                    provider.value,
                                                                                )}
                                                                            </span>
                                                                            {
                                                                                provider.value
                                                                            }
                                                                        </Box>
                                                                    }
                                                                />
                                                            ),
                                                        )}
                                                    </RadioGroup>
                                                </FormControl>
                                            </Grid>
                                        )}
                                    </Grid>
                                </Paper>
                            )}

                            {/* Search Mode */}
                            {mode === "search" && (
                                <Paper sx={{ p: 3, mb: 3 }}>
                                    <TextField
                                        fullWidth
                                        variant="outlined"
                                        placeholder="Search for government services..."
                                        value={searchQuery}
                                        onChange={(e) =>
                                            setSearchQuery(e.target.value)
                                        }
                                        onKeyPress={(e) =>
                                            e.key === "Enter" && handleSearch()
                                        }
                                        InputProps={{
                                            endAdornment: (
                                                <InputAdornment position="end">
                                                    <IconButton
                                                        onClick={handleSearch}
                                                    >
                                                        <span className="material-icons">
                                                            search
                                                        </span>
                                                    </IconButton>
                                                </InputAdornment>
                                            ),
                                        }}
                                    />

                                    {/* Active filters */}
                                    <Box
                                        className="filter-chips"
                                        sx={{ mt: 2 }}
                                    >
                                        {Object.entries(searchFilters).map(
                                            ([key, value]) =>
                                                value && (
                                                    <Chip
                                                        key={key}
                                                        label={value}
                                                        onDelete={() =>
                                                            setSearchFilters({
                                                                ...searchFilters,
                                                                [key]: null,
                                                            })
                                                        }
                                                    />
                                                ),
                                        )}
                                    </Box>
                                </Paper>
                            )}

                            {/* Chat Mode */}
                            {mode === "chat" && (
                                <Paper sx={{ p: 3 }}>
                                    <Typography variant="h5" gutterBottom>
                                        AI Assistant
                                    </Typography>
                                    
                                    {/* Provider Status and Recommendations */}
                                    {modelRecommendations && (modelRecommendations.ollama || modelRecommendations.litellm) && (
                                        <Alert severity="info" sx={{ mb: 2 }}>
                                            <Typography variant="body2" sx={{ mb: 1 }}>
                                                <strong>Expand your AI options:</strong>
                                            </Typography>
                                            {modelRecommendations.ollama && (
                                                <Typography variant="body2" sx={{ mb: 1 }}>
                                                    ðŸ¦™ <strong>Ollama:</strong> {modelRecommendations.ollama}
                                                </Typography>
                                            )}
                                            {modelRecommendations.litellm && (
                                                <Typography variant="body2">
                                                    ðŸŒ <strong>LiteLLM:</strong> {modelRecommendations.litellm}
                                                </Typography>
                                            )}
                                        </Alert>
                                    )}

                                    {modelStatus && !modelStatus.ollama?.available && !modelStatus.litellm?.available && !modelStatus.openai?.available && (
                                        <Alert severity="warning" sx={{ mb: 2 }}>
                                            <Typography variant="body2">
                                                <strong>No AI providers available.</strong> 
                                                {modelStatus.ollama?.error && ` Ollama: ${modelStatus.ollama.error}.`}
                                                {modelStatus.litellm?.error && ` LiteLLM: ${modelStatus.litellm.error}.`}
                                                {modelStatus.openai?.error && ` OpenAI: ${modelStatus.openai.error}.`}
                                            </Typography>
                                        </Alert>
                                    )}
                                    <Box className="chat-messages">
                                        {chatMessages.map((msg, index) => (
                                            <Fade in key={msg.id || index}>
                                                <Box
                                                    className={`chat-message ${msg.type}`}
                                                >
                                                    <Avatar className="chat-avatar">
                                                        {msg.type === "user"
                                                            ? "U"
                                                            : msg.type === "system"
                                                            ? "ðŸ”"  
                                                            : "AI"}
                                                    </Avatar>
                                                    <Paper
                                                        className="chat-bubble"
                                                        elevation={1}
                                                    >
                                                        <Typography variant="body2">
                                                            {msg.loading && (
                                                                <Box
                                                                    sx={{
                                                                        display:
                                                                            "flex",
                                                                        alignItems:
                                                                            "center",
                                                                        gap: 1,
                                                                    }}
                                                                >
                                                                    <CircularProgress
                                                                        size={
                                                                            16
                                                                        }
                                                                    />
                                                                    <span dangerouslySetInnerHTML={{ __html: parseMarkdown(msg.text) }} />
                                                                </Box>
                                                            )}
                                                            {!msg.loading && (
                                                                <span dangerouslySetInnerHTML={{ __html: parseMarkdown(msg.text) }} />
                                                            )}
                                                        </Typography>
                                                        {msg.error && (
                                                            <Typography
                                                                variant="caption"
                                                                color="error"
                                                                sx={{
                                                                    mt: 1,
                                                                    display:
                                                                        "block",
                                                                }}
                                                            >
                                                                Make sure Ollama
                                                                is running:{" "}
                                                                <code>
                                                                    ollama serve
                                                                </code>
                                                            </Typography>
                                                        )}
                                                        {msg.sources && (
                                                            <Box sx={{ mt: 1 }}>
                                                                <Typography variant="caption" color="text.secondary">
                                                                    Sources:
                                                                </Typography>
                                                                {msg.sources.map((source, idx) => (
                                                                    <Typography key={idx} variant="caption" sx={{ display: 'block', ml: 1 }}>
                                                                        â€¢ {source.title} ({source.provider})
                                                                    </Typography>
                                                                ))}
                                                            </Box>
                                                        )}
                                                    </Paper>
                                                </Box>
                                            </Fade>
                                        ))}
                                    </Box>
                                    <Box sx={{ display: "flex", gap: 1, alignItems: "center" }}>
                                        <FormControl size="small" sx={{ minWidth: 320 }}>
                                            <InputLabel id="model-select-label">Model</InputLabel>
                                            <Select
                                                labelId="model-select-label"
                                                label="Model"
                                                value={llmModel}
                                                onChange={(e) => setLlmModel(e.target.value)}
                                            >
                                                {availableModels.map((m) => (
                                                    <MenuItem 
                                                        key={m.value} 
                                                        value={m.value}
                                                        disabled={m.status === 'error'}
                                                    >
                                                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, width: '100%' }}>
                                                            <span>{m.label}</span>
                                                            {m.status === 'available' && (
                                                                <span 
                                                                    className="material-icons" 
                                                                    style={{ fontSize: 16, color: '#4caf50' }}
                                                                >
                                                                    check_circle
                                                                </span>
                                                            )}
                                                            {m.status === 'unavailable' && (
                                                                <span 
                                                                    className="material-icons" 
                                                                    style={{ fontSize: 16, color: '#ff9800' }}
                                                                >
                                                                    warning
                                                                </span>
                                                            )}
                                                            {m.status === 'error' && (
                                                                <span 
                                                                    className="material-icons" 
                                                                    style={{ fontSize: 16, color: '#f44336' }}
                                                                >
                                                                    error
                                                                </span>
                                                            )}
                                                        </Box>
                                                    </MenuItem>
                                                ))}
                                            </Select>
                                        </FormControl>
                                        {/* Refresh models button */}
                                        <IconButton 
                                            onClick={loadModels}
                                            disabled={loadingModels}
                                            size="small"
                                            title="Refresh available models"
                                        >
                                            {loadingModels ? (
                                                <CircularProgress size={16} />
                                            ) : (
                                                <span className="material-icons">refresh</span>
                                            )}
                                        </IconButton>

                                        {/* Provider status indicators */}
                                        {modelStatus && (
                                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                                                {modelStatus.ollama?.available && (
                                                    <Chip 
                                                        size="small" 
                                                        label="Ollama" 
                                                        color="success" 
                                                        variant="outlined"
                                                        icon={<span className="material-icons" style={{fontSize: 14}}>check</span>}
                                                    />
                                                )}
                                                {modelStatus.litellm?.available && (
                                                    <Chip 
                                                        size="small" 
                                                        label="LiteLLM" 
                                                        color="primary" 
                                                        variant="outlined"
                                                        icon={<span className="material-icons" style={{fontSize: 14}}>hub</span>}
                                                    />
                                                )}
                                                {modelStatus.openai?.available && (
                                                    <Chip 
                                                        size="small" 
                                                        label="OpenAI" 
                                                        color="info" 
                                                        variant="outlined"
                                                        icon={<span className="material-icons" style={{fontSize: 14}}>cloud</span>}
                                                    />
                                                )}
                                            </Box>
                                        )}
                                        <TextField
                                            fullWidth
                                            variant="outlined"
                                            placeholder="Ask me anything about government services..."
                                            value={chatInput}
                                            onChange={(e) =>
                                                setChatInput(e.target.value)
                                            }
                                            onKeyPress={(e) =>
                                                e.key === "Enter" &&
                                                handleChatSend()
                                            }
                                        />
                                        <Button
                                            variant="contained"
                                            onClick={handleChatSend}
                                            endIcon={
                                                <span className="material-icons">
                                                    send
                                                </span>
                                            }
                                        >
                                            Send
                                        </Button>
                                    </Box>
                                </Paper>
                            )}

                            {/* Results Display */}
                            {loading && (
                                <Box
                                    sx={{
                                        display: "flex",
                                        justifyContent: "center",
                                        my: 4,
                                    }}
                                >
                                    <CircularProgress />
                                </Box>
                            )}

                            {!loading && results.length > 0 && (
                                <>
                                    {/* Home Mode - Static Content */}
                                    {mode === "home" && (
                                        <Box
                                            sx={{
                                                maxWidth: "800px",
                                                mx: "auto",
                                                "& .fragment-content": {
                                                    mb: 3,
                                                    "& h1, & h2, & h3, & h4, & h5, & h6":
                                                        {
                                                            mt: 2,
                                                            mb: 1,
                                                            fontWeight:
                                                                "normal",
                                                        },
                                                    "& p": {
                                                        mb: 1.5,
                                                        lineHeight: 1.6,
                                                    },
                                                    "& ul, & ol": {
                                                        mb: 1.5,
                                                        pl: 3,
                                                    },
                                                    "& li": { mb: 0.5 },
                                                    "& .info-box, & .alert": {
                                                        p: 2,
                                                        mb: 2,
                                                        borderRadius: 1,
                                                        backgroundColor:
                                                            "#f5f5f5",
                                                        border: "1px solid #e0e0e0",
                                                    },
                                                    "& .alert": {
                                                        backgroundColor:
                                                            "#fff3cd",
                                                        borderColor: "#ffeeba",
                                                        color: "#856404",
                                                    },
                                                    "& table": {
                                                        width: "100%",
                                                        mb: 2,
                                                        borderCollapse:
                                                            "collapse",
                                                        "& th, & td": {
                                                            border: "1px solid #ddd",
                                                            p: 1,
                                                            textAlign: "left",
                                                        },
                                                        "& th": {
                                                            backgroundColor:
                                                                "#f5f5f5",
                                                            fontWeight: "bold",
                                                        },
                                                    },
                                                    "& form": {
                                                        mb: 2,
                                                        p: 2,
                                                        border: "1px solid #ddd",
                                                        borderRadius: 1,
                                                    },
                                                },
                                            }}
                                        >
                                            {/* Page Title (H1) */}
                                            <Typography
                                                variant="h3"
                                                component="h1"
                                                gutterBottom
                                                sx={{ fontWeight: 400, mb: 3 }}
                                            >
                                                {selections.lifeEvent} -{" "}
                                                {selections.category}
                                            </Typography>

                                            <Typography
                                                variant="body1"
                                                sx={{
                                                    mb: 4,
                                                    color: "text.secondary",
                                                }}
                                            >
                                                Information and services for{" "}
                                                {selections.lifeEvent?.toLowerCase()}{" "}
                                                from{" "}
                                                {selections.provider ===
                                                "All providers"
                                                    ? "all government providers"
                                                    : selections.provider}
                                                .
                                            </Typography>

                                            {/* AI Reordering Status */}
                                            {loadingReorder && results.length > 0 && (
                                                <Paper 
                                                    sx={{ 
                                                        p: 2, 
                                                        mb: 3, 
                                                        backgroundColor: '#f8f9fa',
                                                        border: '1px solid #e9ecef'
                                                    }}
                                                >
                                                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                                        <CircularProgress size={16} />
                                                        <Typography variant="body2" color="text.secondary">
                                                            Optimizing content flow for better reading experience...
                                                        </Typography>
                                                    </Box>
                                                </Paper>
                                            )}

                                            {/* Group results hierarchically */}
                                            {(() => {
                                                // Use reordered results if available, otherwise use original results
                                                const resultsToDisplay = reorderedResults || results;
                                                
                                                // Group by category -> life event -> page title
                                                const grouped = resultsToDisplay.reduce(
                                                    (acc, item) => {
                                                        const cat =
                                                            item.category ||
                                                            "General Information";
                                                        const event =
                                                            item.lifeEvent ||
                                                            "General";
                                                        const page =
                                                            item.hierarchy ||
                                                            "Information";

                                                        if (!acc[cat])
                                                            acc[cat] = {};
                                                        if (!acc[cat][event])
                                                            acc[cat][event] =
                                                                {};
                                                        if (
                                                            !acc[cat][event][
                                                                page
                                                            ]
                                                        )
                                                            acc[cat][event][
                                                                page
                                                            ] = [];

                                                        acc[cat][event][
                                                            page
                                                        ].push(item);
                                                        return acc;
                                                    },
                                                    {},
                                                );

                                                return Object.entries(
                                                    grouped,
                                                ).map(
                                                    ([
                                                        category,
                                                        eventGroups,
                                                    ]) => (
                                                        <Box
                                                            key={category}
                                                            sx={{ mb: 5 }}
                                                        >
                                                            {/* H2 - Category */}
                                                            <Typography
                                                                variant="h4"
                                                                component="h2"
                                                                gutterBottom
                                                                sx={{
                                                                    fontWeight: 500,
                                                                    borderBottom:
                                                                        "2px solid #e0e0e0",
                                                                    pb: 1,
                                                                    mb: 3,
                                                                }}
                                                            >
                                                                {category}
                                                            </Typography>

                                                            {Object.entries(
                                                                eventGroups,
                                                            ).map(
                                                                ([
                                                                    event,
                                                                    pageGroups,
                                                                ]) => (
                                                                    <Box
                                                                        key={
                                                                            event
                                                                        }
                                                                        sx={{
                                                                            mb: 4,
                                                                        }}
                                                                    >
                                                                        {/* H3 - Life Event (only if different from selection) */}
                                                                        {event !==
                                                                            selections.lifeEvent && (
                                                                            <Typography
                                                                                variant="h5"
                                                                                component="h3"
                                                                                gutterBottom
                                                                                sx={{
                                                                                    fontWeight: 500,
                                                                                    color: "#1976d2",
                                                                                    mb: 2,
                                                                                }}
                                                                            >
                                                                                {
                                                                                    event
                                                                                }
                                                                            </Typography>
                                                                        )}

                                                                        {Object.entries(
                                                                            pageGroups,
                                                                        ).map(
                                                                            ([
                                                                                pageTitle,
                                                                                items,
                                                                            ]) => (
                                                                                <Box
                                                                                    key={
                                                                                        pageTitle
                                                                                    }
                                                                                    sx={{
                                                                                        mb: 3,
                                                                                    }}
                                                                                >
                                                                                    {/* H4 - Page Title */}
                                                                                    <Typography
                                                                                        variant="h6"
                                                                                        component="h4"
                                                                                        gutterBottom
                                                                                        sx={{
                                                                                            fontWeight: 500,
                                                                                            mb: 2,
                                                                                        }}
                                                                                    >
                                                                                        {
                                                                                            pageTitle
                                                                                        }
                                                                                    </Typography>

                                                                                    {/* Render content fragments as they originally appeared */}
                                                                                    {items.map(
                                                                                        (
                                                                                            item,
                                                                                        ) => (
                                                                                            <Box
                                                                                                key={
                                                                                                    item.id
                                                                                                }
                                                                                                sx={{
                                                                                                    mb: 3,
                                                                                                }}
                                                                                            >
                                                                                                {item.content_html ? (
                                                                                                    <Box
                                                                                                        className="fragment-content"
                                                                                                        dangerouslySetInnerHTML={{
                                                                                                            __html: item.content_html,
                                                                                                        }}
                                                                                                    />
                                                                                                ) : (
                                                                                                    <Box className="fragment-content">
                                                                                                        <Typography
                                                                                                            variant="body1"
                                                                                                            paragraph
                                                                                                        >
                                                                                                            {
                                                                                                                item.description
                                                                                                            }
                                                                                                        </Typography>
                                                                                                    </Box>
                                                                                                )}

                                                                                                {/* Source attribution */}
                                                                                                <Typography
                                                                                                    variant="caption"
                                                                                                    sx={{
                                                                                                        display:
                                                                                                            "block",
                                                                                                        color: "text.secondary",
                                                                                                        fontStyle:
                                                                                                            "italic",
                                                                                                        mb: 2,
                                                                                                    }}
                                                                                                >
                                                                                                    Source:{" "}
                                                                                                    {
                                                                                                        item.provider
                                                                                                    }
                                                                                                    {item.state !==
                                                                                                        "National" &&
                                                                                                        ` (${item.state})`}
                                                                                                    {
                                                                                                        " - "
                                                                                                    }
                                                                                                    <Link
                                                                                                        href={
                                                                                                            item.url
                                                                                                        }
                                                                                                        target="_blank"
                                                                                                        sx={{
                                                                                                            color: "inherit",
                                                                                                        }}
                                                                                                    >
                                                                                                        View
                                                                                                        original
                                                                                                    </Link>
                                                                                                </Typography>
                                                                                            </Box>
                                                                                        ),
                                                                                    )}
                                                                                </Box>
                                                                            ),
                                                                        )}
                                                                    </Box>
                                                                ),
                                                            )}
                                                        </Box>
                                                    ),
                                                );
                                            })()}
                                        </Box>
                                    )}

                                    {/* Browse Mode - Checklist */}
                                    {mode === "browse" && (
                                        <>
                                            {/* Progress Bar (Browse mode only) */}
                                            <Box sx={{ mb: 3 }}>
                                                <Box
                                                    sx={{
                                                        display: "flex",
                                                        justifyContent:
                                                            "space-between",
                                                        mb: 1,
                                                    }}
                                                >
                                                    <Typography variant="h5">
                                                        Your Checklist
                                                    </Typography>
                                                    <Typography
                                                        variant="body2"
                                                        color="text.secondary"
                                                    >
                                                        {completedTasks.length}{" "}
                                                        of {results.length}{" "}
                                                        steps complete
                                                    </Typography>
                                                </Box>
                                                <LinearProgress
                                                    variant="determinate"
                                                    value={progress}
                                                />

                                                <Box
                                                    sx={{
                                                        mt: 2,
                                                        display: "flex",
                                                        gap: 1,
                                                    }}
                                                >
                                                    <Button
                                                        size="small"
                                                        startIcon={
                                                            <span className="material-icons">
                                                                push_pin
                                                            </span>
                                                        }
                                                    >
                                                        Pin to dashboard
                                                    </Button>
                                                    <Button
                                                        size="small"
                                                        startIcon={
                                                            <span className="material-icons">
                                                                share
                                                            </span>
                                                        }
                                                        onClick={(e) =>
                                                            setExportAnchor(
                                                                e.currentTarget,
                                                            )
                                                        }
                                                    >
                                                        Export
                                                    </Button>
                                                    <Menu
                                                        anchorEl={exportAnchor}
                                                        open={Boolean(
                                                            exportAnchor,
                                                        )}
                                                        onClose={() =>
                                                            setExportAnchor(
                                                                null,
                                                            )
                                                        }
                                                    >
                                                        <MenuItem
                                                            onClick={() =>
                                                                window.print()
                                                            }
                                                        >
                                                            <ListItemIcon>
                                                                <span className="material-icons">
                                                                    print
                                                                </span>
                                                            </ListItemIcon>
                                                            Print
                                                        </MenuItem>
                                                        <MenuItem>
                                                            <ListItemIcon>
                                                                <span className="material-icons">
                                                                    picture_as_pdf
                                                                </span>
                                                            </ListItemIcon>
                                                            Download PDF
                                                        </MenuItem>
                                                        <MenuItem>
                                                            <ListItemIcon>
                                                                <span className="material-icons">
                                                                    description
                                                                </span>
                                                            </ListItemIcon>
                                                            Download DOCX
                                                        </MenuItem>
                                                        <Divider />
                                                        <MenuItem>
                                                            <ListItemIcon>
                                                                <span className="material-icons">
                                                                    share
                                                                </span>
                                                            </ListItemIcon>
                                                            Share via email
                                                        </MenuItem>
                                                    </Menu>
                                                </Box>
                                            </Box>

                                            {/* Results organized by hierarchy */}
                                            <Box>
                                                {Object.entries(
                                                    results.reduce(
                                                        (acc, item) => {
                                                            const activity =
                                                                item.hierarchy;
                                                            if (!acc[activity])
                                                                acc[activity] =
                                                                    [];
                                                            acc[activity].push(
                                                                item,
                                                            );
                                                            return acc;
                                                        },
                                                        {},
                                                    ),
                                                ).map(
                                                    (
                                                        [activity, items],
                                                        index,
                                                    ) => {
                                                        const completedInGroup =
                                                            items.filter(
                                                                (item) =>
                                                                    completedTasks.includes(
                                                                        item.id,
                                                                    ),
                                                            ).length;

                                                        return (
                                                            <Accordion
                                                                key={activity}
                                                                defaultExpanded={
                                                                    index === 0
                                                                }
                                                            >
                                                                <AccordionSummary
                                                                    expandIcon={
                                                                        <span className="material-icons">
                                                                            expand_more
                                                                        </span>
                                                                    }
                                                                >
                                                                    <Box
                                                                        sx={{
                                                                            display:
                                                                                "flex",
                                                                            alignItems:
                                                                                "center",
                                                                            width: "100%",
                                                                            pr: 2,
                                                                        }}
                                                                    >
                                                                        <Typography
                                                                            sx={{
                                                                                flexGrow: 1,
                                                                            }}
                                                                        >
                                                                            {
                                                                                activity
                                                                            }{" "}
                                                                            (
                                                                            {
                                                                                items.length
                                                                            }
                                                                            )
                                                                        </Typography>
                                                                        <Chip
                                                                            size="small"
                                                                            label={
                                                                                completedInGroup ===
                                                                                items.length
                                                                                    ? "Complete"
                                                                                    : completedInGroup >
                                                                                        0
                                                                                      ? "In progress"
                                                                                      : "Not started"
                                                                            }
                                                                            color={
                                                                                completedInGroup ===
                                                                                items.length
                                                                                    ? "success"
                                                                                    : completedInGroup >
                                                                                        0
                                                                                      ? "info"
                                                                                      : "default"
                                                                            }
                                                                        />
                                                                    </Box>
                                                                </AccordionSummary>
                                                                <AccordionDetails>
                                                                    <List>
                                                                        {items.map(
                                                                            (
                                                                                item,
                                                                            ) => (
                                                                                <ListItem
                                                                                    key={
                                                                                        item.id
                                                                                    }
                                                                                    sx={{
                                                                                        opacity:
                                                                                            completedTasks.includes(
                                                                                                item.id,
                                                                                            )
                                                                                                ? 0.6
                                                                                                : 1,
                                                                                        "&:hover":
                                                                                            {
                                                                                                bgcolor:
                                                                                                    "action.hover",
                                                                                            },
                                                                                    }}
                                                                                >
                                                                                    <ListItemIcon>
                                                                                        <Checkbox
                                                                                            checked={completedTasks.includes(
                                                                                                item.id,
                                                                                            )}
                                                                                            onChange={() =>
                                                                                                toggleTask(
                                                                                                    item.id,
                                                                                                )
                                                                                            }
                                                                                        />
                                                                                    </ListItemIcon>
                                                                                    <ListItemText
                                                                                        primary={
                                                                                            <Box
                                                                                                sx={{
                                                                                                    display:
                                                                                                        "flex",
                                                                                                    alignItems:
                                                                                                        "center",
                                                                                                    gap: 1,
                                                                                                }}
                                                                                            >
                                                                                                {
                                                                                                    item.title
                                                                                                }
                                                                                                {item.state !==
                                                                                                    "National" && (
                                                                                                    <Chip
                                                                                                        size="small"
                                                                                                        label={
                                                                                                            item.state
                                                                                                        }
                                                                                                    />
                                                                                                )}
                                                                                            </Box>
                                                                                        }
                                                                                        secondary={
                                                                                            <>
                                                                                                <Typography
                                                                                                    variant="body2"
                                                                                                    component="span"
                                                                                                >
                                                                                                    {
                                                                                                        item.description
                                                                                                    }
                                                                                                </Typography>
                                                                                                <br />
                                                                                                <Typography
                                                                                                    variant="caption"
                                                                                                    color="text.secondary"
                                                                                                >
                                                                                                    Provider:{" "}
                                                                                                    {
                                                                                                        item.provider
                                                                                                    }
                                                                                                </Typography>
                                                                                            </>
                                                                                        }
                                                                                        sx={{
                                                                                            textDecoration:
                                                                                                completedTasks.includes(
                                                                                                    item.id,
                                                                                                )
                                                                                                    ? "line-through"
                                                                                                    : "none",
                                                                                        }}
                                                                                    />
                                                                                    <IconButton
                                                                                        href={
                                                                                            item.url
                                                                                        }
                                                                                        target="_blank"
                                                                                        size="small"
                                                                                    >
                                                                                        <span className="material-icons">
                                                                                            open_in_new
                                                                                        </span>
                                                                                    </IconButton>
                                                                                </ListItem>
                                                                            ),
                                                                        )}
                                                                    </List>
                                                                </AccordionDetails>
                                                            </Accordion>
                                                        );
                                                    },
                                                )}
                                            </Box>
                                        </>
                                    )}

                                    {/* Search Mode - Results Grid */}
                                    {mode === "search" && (
                                        <Box>
                                            <Typography
                                                variant="h5"
                                                gutterBottom
                                            >
                                                Search Results ({results.length}
                                                )
                                            </Typography>
                                            
                                            {/* AI Summary Section */}
                                            {(aiSummary || loadingSummary) && results.length > 0 && (
                                                <Paper 
                                                    sx={{ 
                                                        p: 2, 
                                                        mb: 3, 
                                                        backgroundColor: '#f5f5f5',
                                                        border: '1px solid #e0e0e0'
                                                    }}
                                                >
                                                    <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>
                                                        <span className="material-icons" style={{ marginRight: 8, color: '#1976d2' }}>
                                                            summarize
                                                        </span>
                                                        <Typography variant="h6" component="h3">
                                                            AI Summary
                                                        </Typography>
                                                    </Box>
                                                    {loadingSummary ? (
                                                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                                            <CircularProgress size={16} />
                                                            <Typography variant="body2" color="text.secondary">
                                                                Generating summary of search results...
                                                            </Typography>
                                                        </Box>
                                                    ) : (
                                                        <Typography variant="body2" sx={{ whiteSpace: 'pre-wrap' }}>
                                                            {aiSummary}
                                                        </Typography>
                                                    )}
                                                </Paper>
                                            )}
                                            
                                            <Grid container spacing={2}>
                                                {results.map((item) => (
                                                    <Grid
                                                        item
                                                        xs={12}
                                                        md={6}
                                                        key={item.id}
                                                    >
                                                        <Card variant="outlined">
                                                            <CardContent>
                                                                <Typography
                                                                    variant="h6"
                                                                    gutterBottom
                                                                >
                                                                    {item.title}
                                                                </Typography>
                                                                <Typography
                                                                    variant="body2"
                                                                    color="text.secondary"
                                                                    paragraph
                                                                >
                                                                    {
                                                                        item.description
                                                                    }
                                                                </Typography>
                                                                <Box
                                                                    sx={{
                                                                        display:
                                                                            "flex",
                                                                        gap: 1,
                                                                        flexWrap:
                                                                            "wrap",
                                                                        mb: 2,
                                                                    }}
                                                                >
                                                                    <Chip
                                                                        size="small"
                                                                        label={
                                                                            item.category
                                                                        }
                                                                        color="primary"
                                                                        variant="outlined"
                                                                    />
                                                                    <Chip
                                                                        size="small"
                                                                        label={
                                                                            item.provider
                                                                        }
                                                                    />
                                                                    {item.state !==
                                                                        "National" && (
                                                                        <Chip
                                                                            size="small"
                                                                            label={
                                                                                item.state
                                                                            }
                                                                            variant="outlined"
                                                                        />
                                                                    )}
                                                                </Box>
                                                                <Button
                                                                    size="small"
                                                                    href={
                                                                        item.url
                                                                    }
                                                                    target="_blank"
                                                                    endIcon={
                                                                        <span className="material-icons">
                                                                            open_in_new
                                                                        </span>
                                                                    }
                                                                >
                                                                    View details
                                                                </Button>
                                                            </CardContent>
                                                        </Card>
                                                    </Grid>
                                                ))}
                                            </Grid>
                                        </Box>
                                    )}
                                </>
                            )}

                            {/* Empty State */}
                            {!loading &&
                                results.length === 0 &&
                                mode === "search" &&
                                searchQuery && (
                                    <Paper sx={{ p: 4, textAlign: "center" }}>
                                        <Typography variant="h6" gutterBottom>
                                            No results found
                                        </Typography>
                                        <Typography
                                            variant="body2"
                                            color="text.secondary"
                                        >
                                            Try adjusting your search terms or
                                            filters
                                        </Typography>
                                    </Paper>
                                )}
                        </Container>

                        {/* Footer */}
                        <Box
                            component="footer"
                            sx={{
                                bgcolor: "#000",
                                color: "white",
                                py: 6,
                                mt: 8,
                            }}
                        >
                            <Container maxWidth="lg">
                                <Grid container spacing={4}>
                                    <Grid item xs={12} md={3}>
                                        <Typography variant="h6" gutterBottom>
                                            About this site
                                        </Typography>
                                        <List dense>
                                            <ListItem>
                                                <ListItemText primary="About myGov" />
                                            </ListItem>
                                            <ListItem>
                                                <ListItemText primary="Help using myGov" />
                                            </ListItem>
                                            <ListItem>
                                                <ListItemText primary="Contact us" />
                                            </ListItem>
                                        </List>
                                    </Grid>
                                    <Grid item xs={12} md={3}>
                                        <Typography variant="h6" gutterBottom>
                                            Browse
                                        </Typography>
                                        <List dense>
                                            <ListItem>
                                                <ListItemText primary="Raising kids" />
                                            </ListItem>
                                            <ListItem>
                                                <ListItemText primary="Living arrangements" />
                                            </ListItem>
                                            <ListItem>
                                                <ListItemText primary="Work" />
                                            </ListItem>
                                        </List>
                                    </Grid>
                                    <Grid item xs={12} md={6}>
                                        <Typography
                                            variant="body2"
                                            sx={{ mt: 2 }}
                                        >
                                            We acknowledge the Traditional
                                            Custodians of the lands we live on.
                                            We pay our respects to all
                                            Aboriginal and Torres Strait
                                            Islander peoples.
                                        </Typography>
                                    </Grid>
                                </Grid>
                            </Container>
                        </Box>
                    </>
                );
            }

            // Render the app
            ReactDOM.render(<App />, document.getElementById("root"));
        </script>
    </body>
</html>
